<html>

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
	    crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Kanit" rel="stylesheet">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<style>
		body {
			font-family: 'Kanit', sans-serif;
			background-color: #4fc3f7;
		}

		#video {
			background-color: grey;
		}

		#canvas {
			float: left;
			transform: scale(0.5);
			position: absolute;
			transform-origin: top left;
		}

		.result {
			float: left;
			padding: 24px;
			width: 600px;
			position: relative;
			height: 480px;
		}

		#snap {
			margin: auto;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		#processed {
			display: none;
		}

		.ui {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			padding: 22px;
			background-color: white;
			display: -webkit-inline-box;
		}

		#container {
			width: 640px;
		}

		.table>tbody>tr>td {
			vertical-align: middle;
		}

		.table>tbody>tr>th {
			vertical-align: middle;
		}
	</style>
</head>

<body>
	<div class="modal fade" id="notfound" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">ขออภัย ไม่พบสินค้า</h5>
				</div>
				<div class="modal-body">
					กรุณาลองอีกครั้ง
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" onclick="location.reload();">ลองใหม่</button>
				</div>
			</div>
		</div>
	</div>
	<h1>Barcodeless System V.0.1 A</h1>
	<video autoplay="true" id="footage" style="display:none;" width="1000"></video>
	<div class="ui">

		<div id="container">
			<video autoplay="true" id="video" style="float:left; object-fit: cover;" width="640"></video>


			<canvas id="canvas" width="1280" height="960"></canvas>
		</div>
		<div class="result" style="background-color:#fafafa">
			<button type="button" class="btn btn-primary btn-lg" id="snap">คิดเงิน</button>
			<div id="processed">
				<br>
				<br>
				<h3>สินค้าที่พบ</h3>
				<p id="processing" style="display:none;">กำลังประมวลผล</p>
				<table class="table">
					<thead>
						<tr>
							<th scope="col">#</th>
							<th scope="col">ชื่อสินค้า</th>
							<th scope="col">ราคา</th>
							<th scope="col">รหัส</th>
							<th scope="col"></th>
						</tr>
					</thead>
					<tbody id="tbody">

					</tbody>
				</table>
				<button type="button" class="btn btn-success btn-lg">ถูกต้อง</button>
				<button type="button" class="btn btn-danger btn-lg" style="margin-left: 12px;">ลองใหม่ </button>
			</div>
		</div>
	</div>

	</div>


</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script src='node_modules/google-material-color/dist/palette.js'></script>


<script>
	color = ["Red", "Blue", "Cyan", "Green", "Yellow", "Orange", "Brown", "Grey"]
	var xhr = new XMLHttpRequest({
		mozSystem: true
	});
	$("#canvas").hide()
	var video_preview = document.getElementById('video');
	if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
		navigator.mediaDevices.getUserMedia({
			video: true
		}).then(function (stream) {
			video_preview.src = window.URL.createObjectURL(stream);
			video.play();
		});
	}
	var video = document.getElementById('footage');
	if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
		navigator.mediaDevices.getUserMedia({
			video: true
		}).then(function (stream) {
			video.src = window.URL.createObjectURL(stream);
			video.play();
		});
	}
	var canvas = document.getElementById('canvas');
	var context = canvas.getContext('2d');
	var resultlist = [];

	function del(i) {
		var xmin = resultlist[i]["xmin"];
		var xmax = resultlist[i]["xmax"];
		var ymin = resultlist[i]["ymin"];
		var ymax = resultlist[i]["ymax"];
		var xco = (xmin) * 1280
		var yco = (ymin) * 960
		var width = (xmax - xmin) * 1280;
		var height = (ymax - ymin) * 960;
		context.clearRect(xco, yco, width, height);
		$("#row" + i).remove();
		delete resultlist[i]
		console.log(resultlist)
	}
	$("#snap").click(function () {
		$("#processing").fadeIn(200)
		$("#canvas").show();
		context.drawImage(video, 0, 0, 1280, 960);
		uri = canvas.toDataURL("image/jpeg").split(',')[1]
		$("#video").hide();
		video_preview.src = null;
		$("#snap").fadeOut(200);

		topost = {
			"uri": uri
		};

		$.ajax({
			url: 'http://localhost:5000/api/alpha',
			type: 'POST',
			dataType: 'json',
			contentType: "application/json",
			success: function (data) {
				$("#processing").fadeOut(200)
				$("#processed").fadeIn(200);
				var result = data["result"]
				console.log(result)
				if (result.length != 0) {

					$.getJSON("db.json", function (db) {
						db = db["database"][0]
						for (var i = 0; i < result.length; i++) {
							id = result[i]["item"]
							num = i + 1
							$("#tbody").append('<tr id="row' + i + '"><th scope="row">' + num + '</th><td>' + db[id]["name"] +
								'</td><td>' + db[id][
									"price"
								] + '</td><td>' + db[id]["barcode"] +
								'</td><td><button type="button" class="btn btn-danger" onclick="del(' + i +
								')"><i class="material-icons">delete_forever</i></button></td></tr>'
							)
							resultlist.push(result[i])

							var xmin = result[i]["xmin"];
							var xmax = result[i]["xmax"];
							var ymin = result[i]["ymin"];
							var ymax = result[i]["ymax"];
							var xco = (xmin) * 1280
							var yco = (ymin) * 960
							var width = (xmax - xmin) * 1280;
							var height = (ymax - ymin) * 960;
							console.log("width: " + width + "\nheight: " + height + "\nxco: " + xco + "\nyco: " + yco)
							var randcol = palette.get(color[i % 7], '600');
							context.strokeStyle = randcol;
							context.lineWidth = 10;
							console.log(randcol);
							context.strokeRect(xco, yco, width, height);

						}

					});
				} else {
					console.log("empty result")
					$('#notfound').modal('show')
				}

			},
			fail: function () {
				console.log("error occured")
			},
			data: JSON.stringify(topost)
		});
	});
</script>

<script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
<script>
	// Initialize Firebase
	var config = {
		apiKey: "AIzaSyCBqA9dgj0977iVnq-ES7jMjV-OjQI6WKo",
		authDomain: "barcodeless-system.firebaseapp.com",
		databaseURL: "https://barcodeless-system.firebaseio.com",
		projectId: "barcodeless-system",
		storageBucket: "barcodeless-system.appspot.com",
		messagingSenderId: "1026646308125"
	};
	firebase.initializeApp(config);
</script>


</html>